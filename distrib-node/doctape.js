(function(){var t=this.DoctapeCore=function(){this.options={authPt:{protocol:"https",host:"my.doctape.com",port:null,base:"/oauth2"},resourcePt:{protocol:"https",host:"api.doctape.com",port:null,base:"/v1"},scope:[],client_id:null,client_secret:null},this._token={type:null,timeout:null,timestamp:null,access:null,refresh:null},this.env={emit:null,subscribe:null,unsubscribe:null,req:null}},e=t.prototype.setToken=function(t){this._token.type=t.token_type,this._token.timeout=t.expires_in,this._token.timestamp=t.timestamp||(new Date).getTime(),this._token.access=t.access_token,this._token.refresh=t.refresh_token},o=t.prototype.token=function(){return{token_type:this._token.type,expires_in:this._token.timeout,timestamp:this._token.timestamp,access_token:this._token.access,refresh_token:this._token.refresh}};t.prototype.setAuthPt=function(t){var e=t.match(/([a-z]+):\/\/([^:]+):?([0-9]+)?(\/.*)/);this.options.authPt.protocol=e[1]||null,this.options.authPt.host=e[2]||null,this.options.authPt.port=parseInt(e[3],10)||null,this.options.authPt.base=e[4]||null},t.prototype.authBase=function(){return this.options.authPt.protocol+"://"+this.options.authPt.host+(this.options.authPt.port?":"+this.options.authPt.port:"")},t.prototype.authPath=function(t,e){var o=t||"urn:ietf:wg:oauth:2.0:oob";return this.options.authPt.base+"?"+"response_type="+(e||"code")+"&"+"client_id="+encodeURIComponent(this.options.client_id)+"&"+"scope="+encodeURIComponent(this.options.scope.join(" "))+"&"+"redirect_uri="+o},t.prototype.setResourcePt=function(t){var e=t.match(/([a-z]+):\/\/([^:]+):?([0-9]+)?(\/.*)/);this.options.resourcePt.protocol=e[1]||null,this.options.resourcePt.host=e[2]||null,this.options.resourcePt.port=parseInt(e[3],10)||null,this.options.resourcePt.base=e[4]||null},t.prototype.resourcePt=function(){return this.options.resourcePt.protocol+"://"+this.options.resourcePt.host+(this.options.resourcePt.port?":"+this.options.resourcePt.port:"")+this.options.resourcePt.base};var n=function(t,e,o){var n,i=[];for(n in e)i.push(n+"="+encodeURIComponent(e[n]));this.env.req({method:"POST",protocol:this.options.authPt.protocol,host:this.options.authPt.host,port:this.options.authPt.port,path:this.options.authPt.base+t,headers:{"Content-Type":"application/x-www-form-urlencoded"},postData:i.join("&")},o)};t.prototype.getResource=function(t,e){var o=this;i.call(this,function(n){o.env.req({method:"GET",protocol:o.options.resourcePt.protocol,host:o.options.resourcePt.host,port:o.options.resourcePt.port,path:o.options.resourcePt.base+t,headers:{Authorization:"Bearer "+n}},e)})},t.prototype.postResource=function(t,e,o){var n=this;i.call(this,function(i){n.env.req({method:"POST",protocol:n.options.resourcePt.protocol,host:n.options.resourcePt.host,port:n.options.resourcePt.port,path:n.options.resourcePt.base+t,headers:{Authorization:"Bearer "+i,"Content-Type":"application/json; charset=UTF-8"},postData:JSON.stringify(e)},o)})},t.prototype.deleteResource=function(t,e){var o=this;i.call(this,function(n){o.env.req({method:"DELETE",protocol:o.options.resourcePt.protocol,host:o.options.resourcePt.host,port:o.options.resourcePt.port,path:o.options.resourcePt.base+t,headers:{Authorization:"Bearer "+n}},e)})},t.prototype.getValidAccessToken=function(){if(this._token.access&&this._token.timestamp+1e3*this._token.timeout>(new Date).getTime())return this._token.access;throw Error("Access Token Expired")};var i=t.prototype.withValidAccessToken=function(t){if(this._token.access&&this._token.timestamp+1e3*this._token.timeout>(new Date).getTime())return t(this._token.access);var e=this,o=function(){i.call(e,t),p.call(e,"auth.refresh",o)};u.call(this,"auth.refresh",o),r.call(this)},s=function(t){var n=this;return function(i,s){if(n._lock_refresh=void 0,!i){var r=JSON.parse(s);return r.error?c.call(n,"auth.fail",t+": "+JSON.stringify(r.error)):(e.call(n,r),c.call(n,"auth.refresh",o.call(n)))}return c.call(n,"auth.fail",t+": "+JSON.stringify(i))}};t.prototype.exchange=function(t){void 0===this._lock_refresh&&(this._lock_refresh=!0,n.call(this,"/token",{code:t,client_id:this.options.client_id,client_secret:this.options.client_secret,redirect_uri:"urn:ietf:wg:oauth:2.0:oob",grant_type:"authorization_code"},s.call(this,"error exchanging token")))};var r=t.prototype.refresh=function(){void 0===this._lock_refresh&&(this._lock_refresh=!0,n.call(this,"/token",{refresh_token:this._token.refresh,client_id:this.options.client_id,client_secret:this.options.client_secret,grant_type:"refresh_token"},s.call(this,"error refreshing token")))},c=t.prototype.emit=function(t,e){this.env.emit(t,e)},u=t.prototype.subscribe=function(t,e){this.env.subscribe(t,e)},p=t.prototype.unsubscribe=function(t,e){this.env.unsubscribe(t,e)}}).call(this),function(){var t=this.DoctapeCore,e=this.DoctapeSimple=function(e){if("object"!=typeof e||void 0===e.scope||void 0===e.appType||void 0===e.appId||void 0===e.callbackURL)throw"Incomplete Doctape Configuration!";if("server"!==e.appType&&"client"!==e.appType)throw"Invalid App Type!";var o=this.core=new t;o.options.scope=e.scope,o.options.client_id=e.appId,o.options.client_secret=e.appSecret||null,this.authBase=o.authBase(),this.authPath=o.authPath(e.callbackURL,"server"===e.appType?"code":"token"),this.authURL=this.authBase+this.authPath,this.resourceURL=o.resourcePt(),this.onauthfail=null};e.prototype.init=function(){var t=this;this.core.subscribe("auth.fail",function(){"function"==typeof t.onauthfail&&t.onauthfail()})},e.prototype.getValidAccessToken=function(){this.core.getValidAccessToken()},e.prototype.withValidAccessToken=function(t){this.core.withValidAccessToken(t)},e.prototype.useCode=function(t,e){var o=this,n=function(){o.core.unsubscribe("auth.refresh",n),"function"==typeof e&&e.call(o)};this.core.subscribe("auth.fail",function(){o.core.unsubscribe("auth.refresh",n)}),this.core.subscribe("auth.refresh",n),this.core.exchange(t)},e.prototype.useToken=function(t,e){this.core.setToken(t),e.call(this)};var o=function(t,e,o){var n=!0;return function(i,s){try{if(i)throw""+i;s=o(s)}catch(r){if(n=!1,"function"!=typeof e)throw r;e(r)}n&&("function"==typeof t?t(s):"function"==typeof e&&e(null,s))}},n=function(t,e){return o(t,e,function(t){if(json=JSON.parse(t),json.error)throw""+json.error;return json.result})},i=function(t,e){return o(t,e,function(t){return t})};e.prototype.getAccount=function(t,e){this.core.getResource("/account",n(t,e))},e.prototype.getAvatar=function(t,e,o){this.core.getResource("/account/avatar/"+t,i(e,o))},e.prototype.getDocumentList=function(t,e){this.core.getResource("/doc?include_meta=false",n(t,e))},e.prototype.getDocumentListWithMetadata=function(t,e){this.core.getResource("/doc?include_meta=true",n(t,e))},e.prototype.getDocumentInfo=function(t,e,o){this.core.getResource("/doc/"+t,n(e,o))},e.prototype.setDocumentInfo=function(t,e,o,i){this.core.postResource("/doc/"+t,e,n(o,i))},e.prototype.setDocumentTags=function(t,e,o,n){this.setDocumentInfo(t,{tags:e},o,n)},e.prototype.setDocumentName=function(t,e,o,n){this.setDocumentInfo(t,{name:e},o,n)},e.prototype.getDocumentOriginal=function(t,e,o){this.core.getResource("/doc/"+t+"/original",i(e,o))},e.prototype.getDocumentThumbnail=function(t,e,o){this.core.getResource("/doc/"+t+"/thumb_120.jpg",i(e,o))},e.prototype.getDocumentThumbnailLarge=function(t,e,o){this.core.getResource("/doc/"+t+"/thumb_320.jpg",i(e,o))},e.prototype.cloneDocument=function(t,e,o){this.core.postResource("/doc/"+t+"/clone",n(e,o))},e.prototype.setDocumentPublicState=function(t,e,o,i){this.core.postResource("/doc/"+t+"/public",{"public":e},n(o,i))},e.prototype.publishDocument=function(t,e,o){this.setDocumentPublicState(t,!0,e,o)},e.prototype.unpublishDocument=function(t,e,o){this.setDocumentPublicState(t,!1,e,o)},e.prototype.deleteDocument=function(t,e,o){this.core.deleteResource("/doc/"+t,n(e,o))},e.prototype.extractArchiveContents=function(t,e,o){this.core.postResource("/doc/"+t+"/extract",n(e,o))}}.call(this);var util=require("util"),events=require("events"),http=require("http"),https=require("https"),DoctapeSimple=this.DoctapeSimple,Doctape=module.exports=function(t){var e=new DoctapeSimple(t);e.prototype=DoctapeSimple;var o=new events.EventEmitter;return e.core.env.emit=function(t,e){o.emit(t,e)},e.core.env.subscribe=function(t,e){o.addListener(t,e)},e.core.env.unsubscribe=function(t,e){o.removeListener(t,e)},e.core.env.req=function(t,e){var o="http"===t.protocol?http:https;t.protocol=void 0;var n=o.request(t,function(t){var o="";t.setEncoding("utf8"),t.on("data",function(t){o+=t}),t.on("end",function(){e(null,o)})});n.on("error",function(t){e(t)}),t.postData&&n.write(t.postData),n.end()},e.init(),e};