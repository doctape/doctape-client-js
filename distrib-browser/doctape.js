(function(){var t=this.DoctapeCore=function(){this.options={authPt:{protocol:"https",host:"my.doctape.com",port:null,base:"/oauth2"},resourcePt:{protocol:"https",host:"api.doctape.com",port:null,base:"/v1"},scope:[],client_id:null,client_secret:null},this._token={type:null,timeout:null,timestamp:null,access:null,refresh:null},this.env={emit:null,subscribe:null,unsubscribe:null,req:null}},e=t.prototype.setToken=function(t){this._token.type=t.token_type,this._token.timeout=t.expires_in,this._token.timestamp=t.timestamp||(new Date).getTime(),this._token.access=t.access_token,this._token.refresh=t.refresh_token},o=t.prototype.token=function(){return{token_type:this._token.type,expires_in:this._token.timeout,timestamp:this._token.timestamp,access_token:this._token.access,refresh_token:this._token.refresh}};t.prototype.setAuthPt=function(t){var e=t.match(/([a-z]+):\/\/([^:]+):?([0-9]+)?(\/.*)/);this.options.authPt.protocol=e[1]||null,this.options.authPt.host=e[2]||null,this.options.authPt.port=parseInt(e[3],10)||null,this.options.authPt.base=e[4]||null},t.prototype.authBase=function(){return this.options.authPt.protocol+"://"+this.options.authPt.host+(this.options.authPt.port?":"+this.options.authPt.port:"")},t.prototype.authPath=function(t,e){var o=t||"urn:ietf:wg:oauth:2.0:oob";return this.options.authPt.base+"?"+"response_type="+(e||"code")+"&"+"client_id="+encodeURIComponent(this.options.client_id)+"&"+"scope="+encodeURIComponent(this.options.scope.join(" "))+"&"+"redirect_uri="+o},t.prototype.setResourcePt=function(t){var e=t.match(/([a-z]+):\/\/([^:]+):?([0-9]+)?(\/.*)/);this.options.resourcePt.protocol=e[1]||null,this.options.resourcePt.host=e[2]||null,this.options.resourcePt.port=parseInt(e[3],10)||null,this.options.resourcePt.base=e[4]||null},t.prototype.resourcePt=function(){return this.options.resourcePt.protocol+"://"+this.options.resourcePt.host+(this.options.resourcePt.port?":"+this.options.resourcePt.port:"")+this.options.resourcePt.base};var n=function(t,e,o){var n,i=[];for(n in e)i.push(n+"="+encodeURIComponent(e[n]));this.env.req({method:"POST",protocol:this.options.authPt.protocol,host:this.options.authPt.host,port:this.options.authPt.port,path:this.options.authPt.base+t,headers:{"Content-Type":"application/x-www-form-urlencoded"},postData:i.join("&")},o)},i=function(t,e,o,n){var i=this.options.resourcePt;return{method:t,protocol:i.protocol,host:i.host,port:i.port,path:i.base+e,headers:o,postData:n}};t.prototype.getResource=function(t,e){var o=this;s.call(this,function(n){o.env.req(i.call(o,"GET",t,{Authorization:"Bearer "+n}),e)})},t.prototype.postResource=function(t,e,o){var n=this;s.call(this,function(s){n.env.req(i.call(n,"POST",t,{Authorization:"Bearer "+s,"Content-Type":"application/json; charset=UTF-8"},JSON.stringify(e)),o)})},t.prototype.deleteResource=function(t,e){var o=this;s.call(this,function(n){o.env.req(i.call(o,"DELETE",t,{Authorization:"Bearer "+n}),e)})};var s=t.prototype.withValidAccessToken=function(t){var e=this,o=function(){var o=function(){s.call(e,t),p.call(e,"auth.refresh",o)};a.call(e,"auth.refresh",o),c.call(e)};this._token.access&&this._token.timeout&&this._token.timestamp+1e3*this._token.timeout>(new Date).getTime()?this.env.req(i.call(this,"GET","/account",{Authorization:"Bearer "+this._token.access}),function(n){return n?o():(t(e._token.access),void 0)}):o()},r=function(t){var n=this;return function(i,s){if(n._lock_refresh=void 0,!i){var r=JSON.parse(s);return r.error?u.call(n,"auth.fail",t+": "+JSON.stringify(r.error)):(e.call(n,r),u.call(n,"auth.refresh",o.call(n)))}return u.call(n,"auth.fail",t+": "+JSON.stringify(i))}};t.prototype.exchange=function(t){void 0===this._lock_refresh&&(this._lock_refresh=!0,n.call(this,"/token",{code:t,client_id:this.options.client_id,client_secret:this.options.client_secret,redirect_uri:"urn:ietf:wg:oauth:2.0:oob",grant_type:"authorization_code"},r.call(this,"error exchanging token")))};var c=t.prototype.refresh=function(){void 0===this._lock_refresh&&(this._lock_refresh=!0,n.call(this,"/token",{refresh_token:this._token.refresh,client_id:this.options.client_id,client_secret:this.options.client_secret,grant_type:"refresh_token"},r.call(this,"error refreshing token")))},u=t.prototype.emit=function(t,e){this.env.emit(t,e)},a=t.prototype.subscribe=function(t,e){this.env.subscribe(t,e)},p=t.prototype.unsubscribe=function(t,e){this.env.unsubscribe(t,e)}}).call(this),function(){var t=this.DoctapeCore,e=this.DoctapeSimple=function(e){if("object"!=typeof e||void 0===e.scope||void 0===e.appType||void 0===e.appId||void 0===e.callbackURL)throw"Incomplete Doctape Configuration!";if("server"!==e.appType&&"client"!==e.appType)throw"Invalid App Type!";var o=this.core=new t;o.options.scope=e.scope,o.options.client_id=e.appId,o.options.client_secret=e.appSecret||null,this.authBase=o.authBase(),this.authPath=o.authPath(e.callbackURL,"server"===e.appType?"code":"token"),this.authURL=this.authBase+this.authPath,this.resourceURL=o.resourcePt(),this.onauthfail=null};e.prototype.init=function(){var t=this;this.core.subscribe("auth.fail",function(){"function"==typeof t.onauthfail&&t.onauthfail()})},e.prototype.getValidAccessToken=function(){this.core.getValidAccessToken()},e.prototype.withValidAccessToken=function(t){this.core.withValidAccessToken(t)},e.prototype.useCode=function(t,e){var o=this,n=function(){o.core.unsubscribe("auth.refresh",n),"function"==typeof e&&e.call(o)};this.core.subscribe("auth.fail",function(){o.core.unsubscribe("auth.refresh",n)}),this.core.subscribe("auth.refresh",n),this.core.exchange(t)},e.prototype.useToken=function(t,e){var o=this;this.core.setToken(t),this.withValidAccessToken(function(){e.call(o)})};var o=function(t,e,o){var n=!0;return function(i,s){try{if(i)throw""+i;s=o(s)}catch(r){if(n=!1,"function"!=typeof e)throw r;e(r)}n&&("function"==typeof t?t(s):"function"==typeof e&&e(null,s))}},n=function(t,e){return o(t,e,function(t){if(json=JSON.parse(t),json.error)throw""+json.error;return json.result})},i=function(t,e){return o(t,e,function(t){return t})};e.prototype.getAccount=function(t,e){this.core.getResource("/account",n(t,e))},e.prototype.getAvatar=function(t,e,o){this.core.getResource("/account/avatar/"+t,i(e,o))},e.prototype.getDocumentList=function(t,e){this.core.getResource("/doc?include_meta=false",n(t,e))},e.prototype.getDocumentListWithMetadata=function(t,e){this.core.getResource("/doc?include_meta=true",n(t,e))},e.prototype.getDocumentInfo=function(t,e,o){this.core.getResource("/doc/"+t,n(e,o))},e.prototype.setDocumentInfo=function(t,e,o,i){this.core.postResource("/doc/"+t,e,n(o,i))},e.prototype.setDocumentTags=function(t,e,o,n){this.setDocumentInfo(t,{tags:e},o,n)},e.prototype.setDocumentName=function(t,e,o,n){this.setDocumentInfo(t,{name:e},o,n)},e.prototype.getDocumentOriginal=function(t,e,o){this.core.getResource("/doc/"+t+"/original",i(e,o))},e.prototype.getDocumentThumbnail=function(t,e,o){this.core.getResource("/doc/"+t+"/thumb_120.jpg",i(e,o))},e.prototype.getDocumentThumbnailLarge=function(t,e,o){this.core.getResource("/doc/"+t+"/thumb_320.jpg",i(e,o))},e.prototype.cloneDocument=function(t,e,o){this.core.postResource("/doc/"+t+"/clone",n(e,o))},e.prototype.setDocumentPublicState=function(t,e,o,i){this.core.postResource("/doc/"+t+"/public",{"public":e},n(o,i))},e.prototype.publishDocument=function(t,e,o){this.setDocumentPublicState(t,!0,e,o)},e.prototype.unpublishDocument=function(t,e,o){this.setDocumentPublicState(t,!1,e,o)},e.prototype.deleteDocument=function(t,e,o){this.core.deleteResource("/doc/"+t,n(e,o))},e.prototype.extractArchiveContents=function(t,e,o){this.core.postResource("/doc/"+t+"/extract",n(e,o))}}.call(this),window.Doctape=function(t){var e=new DoctapeSimple(t);e.prototype=DoctapeSimple,function(){var t={};this.emit=function(e,o){setTimeout(function(){var n,i;if(void 0!==t[e]&&(i=t[e].length)>0)for(n=0;i>n;n++)"function"==typeof t[e][n]&&t[e][n](o)},0)},this.subscribe=function(e,o){void 0===t[e]?t[e]=[o]:-1===t[e].indexOf(o)&&t[e].push(o)},this.unsubscribe=function(e,o){var n;void 0!==t[e]&&-1!==(n=t[e].indexOf(o))&&t[e].splice(n,1)}}.call(e.core.env),e.core.env.req=function(t,e){var o,n=t.headers||{},i=t.method||"GET",s=t.protocol+"://"+t.host+(t.port?":"+t.port:"")+t.path,r=new XMLHttpRequest;r.open(i,s);for(o in n)r.setRequestHeader(o,n[o]);r.onreadystatechange=function(){4===r.readyState&&(null!==r.responseText?e(null,r.responseText):e(r.statusText))},r.send(t.postData)};var o=function(){var t,e,o={},n=window.location.hash.substr(1).split("&");for(t=0;n.length>t;t++)e=n[t].split("="),o[decodeURIComponent(e[0])]=decodeURIComponent(e[1]);return o};return e.run=function(t){var n=o();n.access_token===void 0&&n.error===void 0?window.location=e.authURL+"&state="+encodeURIComponent(n.state):e.useToken({token_type:"Bearer",expires_in:3600,access_token:n.access_token},t)},e.init(),e};